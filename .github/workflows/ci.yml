name: CI

on: [pull_request, push]

jobs:
  formatting:
    runs-on: ubuntu-22.04
    steps:
    - uses: cachix/install-nix-action@v20
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - uses: actions/checkout@v3
    - name: Build shell
      run: nix-shell --run true
    - name: Install npm deps
      run: nix-shell --run "cd pkgs/espressos-web && npm install"
    - name: Check format
      run: nix-shell --run "treefmt --fail-on-change"

  espressos:
    runs-on: ubuntu-22.04
    steps:
    - uses: cachix/install-nix-action@v20
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - uses: actions/checkout@v3
    - name: Build shell
      run: nix-shell --run true
    - name: Build
      run: nix-shell --run "cd pkgs/espressos && make"

  espressos-web:
    runs-on: ubuntu-22.04
    steps:
    - uses: cachix/install-nix-action@v20
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - uses: actions/checkout@v3
    - name: Build shell
      run: nix-shell --run true
    - name: Install npm deps
      run: nix-shell --run "cd pkgs/espressos-web && npm install"
    - name: Build web
      run: nix-shell --run "cd pkgs/espressos-web && npm run build"
